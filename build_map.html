<!DOCTYPE  html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Stardust Script - Making map</title>

	<link href="css/pepper-grinder/jquery-ui-1.10.4.custom.css" rel="stylesheet">
	<script src="src/jquery-2.1.1.min.js"></script>
	<script src="src/jquery-ui-1.10.4.custom.min.js"></script>

	<script src="src/createjs-2013.12.12.min.js"></script>
	<script src="pic/map/texture/adding.js"></script>
	<script src="pic/map/object/adding.js"></script>
	<script src="src/build/light_effect.js"></script>
	<script src="src/build/global_values.js"></script>
	<script src="src/build/material_box.js"></script>
	<script src="src/build/preview_box.js"></script>

	<script>
		var stage ;
		function init() {
			stage = new createjs.Stage( "myCanvas" ) ;
    		document.body.style.cursor = "url('pic/cursor/normal_select.cur'), default" ;

			var material = new MaterialBox() ;
			var preview = new PreviewBox( material ) ;

			stage.addChild( preview.box, material.box ) ;

			// 換面更新幀數
			createjs.Ticker.addEventListener( "tick", tick ) ;
			createjs.Ticker.setFPS( 60 ) ;

			function tick( event ) {
				stage.update() ;
			} // tick()

			// jQuery Setting.
			$( '#dialog_newMap' ).dialog({
				autoOpen: false,
				height: 200,
				modal: true,
				show: { effect: "blind", duration: 1000 },
				hide: { effect: "blind", duration: 500 },
				buttons: {
					"Create": function() {
						$( this ).dialog( "close" ) ;
						$( "#dialog_keySize" ).dialog( "open" ) ;
					},
					"Cancel": function() {
						$( this ).dialog( "close" ) ;
					}
				}
			}) ;
			// jQuery Setting.
			$( '#dialog_keySize' ).dialog({
				autoOpen: false,
				height: 310,
				modal: true,
				show: { effect: "blind", duration: 1000 },
				hide: { effect: "blind", duration: 500 },
				buttons: {
					"Done": function() {
						G.customer_height = $( '#height' ).val() ;
						G.customer_length = $( '#length' ).val() ;
						preview.OnTiledControl() ;
						$( this ).dialog( "close" ) ;
					},
					"Cancel": function() {
						$( this ).dialog( "close" ) ;
					}
				}
			}) ;
			// jQuery Setting.
			$( '#dialog_saveMap' ).dialog({
				autoOpen: false,
				height: 200,
				modal: true,
				show: { effect: "blind", duration: 1000 },
				hide: { effect: "blind", duration: 500 },
				buttons: {
					"Save": function() {
						$( this ).dialog( "close" ) ;
						$( '#jsonExport' ).val( "" ) ;
						$( "#dialog_jsonExport" ).dialog( "open" ) ;
					},
					"Load": function() {
						$( this ).dialog( "close" ) ;
						$( '#jsonImport' ).val( "" ) ;
						$( "#dialog_jsonImport" ).dialog( "open" ) ;
					},
					"Cancel": function() {
						$( this ).dialog( "close" ) ;
					}
				}
			}) ;
			// jQuery Setting.
			$( '#dialog_jsonExport' ).dialog({
				autoOpen: false,
				height: 310,
				modal: true,
				show: { effect: "blind", duration: 1000 },
				hide: { effect: "blind", duration: 500 },
				buttons: {
					"Get the json": function() {
						var obj = {
							tilePixel : G.size,
							name : 'HelloWorld',
							height : G.customer_height,
							length : G.customer_length,
							tileData : preview.box.mapbox.tiled_data,
							objectData : preview.box.mapbox.object_data,
							lightData : [],
							soundData : []
						} ;
						var json = JSON.stringify( obj ) ;
						$( '#jsonExport' ).val( json ) ;
					},
					"Cancel": function() {
						$( this ).dialog( "close" ) ;
					}
				}
			}) ;
			// jQuery Setting.
			$( '#dialog_jsonImport' ).dialog({
				autoOpen: false,
				height: 310,
				modal: true,
				show: { effect: "blind", duration: 1000 },
				hide: { effect: "blind", duration: 500 },
				buttons: {
					"Set the json": function() {
						var obj = eval ( "(" + $( '#jsonImport' ).val() + ")" ) ;
						G.customer_height = obj.height ;
						G.customer_length = obj.length ;
						// Tiled data.
						preview.box.mapbox.tiled_data = obj.tileData ;
						// Initial objects data at mapbox.
						preview.box.mapbox.object_data = obj.objectData ;
						for ( i = 1 ; i < preview.box.mapbox.objects.getNumChildren() ; i ++ )
							preview.box.mapbox.objects.removeChildAt( i ) ;
						// Objects data.
						for ( i = 0 ; i < obj.objectData.length ; i ++ )
							for ( j = 0 ; j < obj.objectData.length ; j ++ )
								if ( i == obj.objectData[j].o ) {
									var container = new createjs.Container() ;
									container.x = container.storeX = obj.objectData[j].rx ;
									container.y = container.storeY = obj.objectData[j].ry ;
									container.order = obj.objectData[j].o ;
									container.objects = G.cacheObjects[obj.objectData[j].n-1].clone( false ) ;
									var objectWidth = container.objects.getBounds().width ;
									var objectHeight = container.objects.getBounds().height ;
									container.objects.regX = objectWidth / 2 ;
									container.objects.regY = objectHeight / 2 ;
									container.objects.x = container.objects.regX + 10, container.objects.y = container.objects.regY + 10 ;
									container.addChild( container.objects ) ;
									container.regX = container.objects.regX + 10, container.regY = container.objects.regY + 10 ;
									container.scaleX = obj.objectData[j].sx, container.scaleY = obj.objectData[j].sy ;
									container.bg = new createjs.Shape() ;
									container.bg.graphics.f( "#AAAAAA" ).s( "#000000" ).r( 0, 0, container.getBounds().width + 20, container.getBounds().height + 20 ) ;
									container.bg.alpha = 0 ;
									container.tools = preview.GetToolsBox( container ) ;
									preview.ToolsBoxListener( container ) ;
									preview.box.mapbox.objects.addChild( container ) ;
								} // if
					},
					"Cancel": function() {
						$( this ).dialog( "close" ) ;
					}
				}
			}) ;
		} // init()
	</script>

	<script>
	$( document ).ready( function() {
		$( document ).bind( "contextmenu", function( event ) { return false ; } ) ;
	} ) ;
	</script>

	<style>
		#myCanvas {
			top: 50% ;
			left: 50% ;
			margin-left: -500px ;
			margin-top: -285px ;
			border-radius: 10px ;
			position: absolute ;
		}
	</style>
</head>

<body onload="init()" background="pic/backgroung.png">
	<canvas id="myCanvas" width="1000" height="550">
		Alternative Content
	</canvas>

	<div id="dialog_newMap" title="Tiled Map Editor" number=1>
		<p>Do yo wanna create a new map?</p>
	</div>

	<div id="dialog_keySize" title="Tiled Map Editor">
		<p>Please key in you map size.</p>
		<br />
		<label for="length">Length</label>
		<input type="text" name="length" id="length" value="" class="text ui-widget-content ui-corner-all">
		<br /><br />
		<label for="height">Height</label>
		<input type="text" name="height" id="height" value="" class="text ui-widget-content ui-corner-all">
	</div>

	<div id="dialog_saveMap" title="Tiled Map Editor">
		<p>Wanna save or load the map?</p>
	</div>

	<div id="dialog_jsonExport" title="Tiled Map Editor">
		<p>You can copy it.</p>
		<textarea type="text" name="jsonExport" id="jsonExport" value="" class="text ui-widget-content ui-corner-all" style="width:100%; height:65%;"></textarea>
	</div>

	<div id="dialog_jsonImport" title="Tiled Map Editor">
		<p>You can key the json of the map.</p>
		<textarea type="text" name="jsonImport" id="jsonImport" value="" class="text ui-widget-content ui-corner-all" style="width:100%; height:65%;"></textarea>
	</div>

	<a href="https://github.com/grass0916/Stardust-Script"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>
</body>

</html>